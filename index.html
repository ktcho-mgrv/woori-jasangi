<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ìš°ë¦¬ ì§‘ ìì‚°ê´€ë¦¬</title>

  <!-- PWA -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ìš°ë¦¬ì§‘ìì‚°" />
  <meta name="theme-color" content="#2A9D8F" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root {
      --teal: #2A9D8F;
      --teal-light: #4DB6AC;
      --teal-dark: #1E7A70;
      --cream: #FFF8F0;
      --warm-gray: #F5F0EA;
      --text-primary: #2C3E50;
      --text-secondary: #7F8C8D;
      --positive: #27AE60;
      --negative: #E74C3C;
      --gold: #F39C12;
      --card-bg: #FFFFFF;
      --border: #E8E0D5;
      --shadow: 0 2px 12px rgba(42,157,143,0.08);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', 'Malgun Gothic', sans-serif;
      background: var(--cream);
      color: var(--text-primary);
      min-height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      position: relative;
      overflow-x: hidden;
    }

    /* â”€â”€ ì—°ê²° ìƒíƒœ ë°°ë„ˆ â”€â”€ */
    .sync-banner {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 999;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      padding: 6px 16px;
      padding-top: calc(6px + var(--safe-top));
      transition: all 0.3s;
      max-width: 480px;
      margin: 0 auto;
    }
    .sync-banner.connecting { background: #F39C12; color: white; }
    .sync-banner.connected  { background: var(--teal); color: white; }
    .sync-banner.offline    { background: #E74C3C; color: white; }
    .sync-banner.hidden     { display: none; }

    /* â”€â”€ í—¤ë” â”€â”€ */
    .app-header {
      background: var(--teal);
      color: white;
      padding: 12px 20px 14px;
      padding-top: calc(12px + var(--safe-top));
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .app-header-inner { display: flex; justify-content: space-between; align-items: center; }
    .app-header h1 { font-size: 18px; font-weight: 700; }
    .app-header .subtitle { font-size: 11px; opacity: 0.8; margin-top: 2px; }
    .sync-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,0.4);
      transition: background 0.3s;
      flex-shrink: 0;
    }
    .sync-dot.live { background: #A8F0B8; animation: pulse 2s infinite; }
    .sync-dot.offline { background: #FF8A80; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* â”€â”€ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€ */
    .tab-nav {
      display: flex;
      background: white;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 62px;
      z-index: 99;
    }
    .tab-btn {
      flex: 1;
      padding: 10px 4px 8px;
      border: none;
      background: transparent;
      font-size: 10px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      transition: all 0.2s;
    }
    .tab-btn .tab-icon { font-size: 20px; }
    .tab-btn.active { color: var(--teal); border-bottom: 2px solid var(--teal); }

    /* â”€â”€ í™”ë©´ â”€â”€ */
    .screen { display: none; padding: 14px 14px calc(20px + var(--safe-bottom)); }
    .screen.active { display: block; }

    /* â”€â”€ ì¹´ë“œ â”€â”€ */
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .card-title {
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 12px;
    }

    /* â”€â”€ í™ˆ â”€â”€ */
    .net-worth-card {
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-dark) 100%);
      color: white;
      border-radius: 20px;
      padding: 24px 20px;
      margin-bottom: 12px;
      text-align: center;
    }
    .net-worth-label { font-size: 12px; opacity: 0.85; margin-bottom: 6px; }
    .net-worth-value { font-size: 34px; font-weight: 800; letter-spacing: -1px; }
    .net-worth-sub { font-size: 11px; opacity: 0.75; margin-top: 6px; }
    .net-worth-breakdown {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    .breakdown-item { text-align: center; }
    .breakdown-label { font-size: 10px; opacity: 0.7; }
    .breakdown-value { font-size: 15px; font-weight: 700; margin-top: 2px; }

    .goal-item { margin-bottom: 14px; }
    .goal-item:last-child { margin-bottom: 0; }
    .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .goal-name { font-size: 14px; font-weight: 600; }
    .goal-emoji { margin-right: 5px; }
    .goal-pct { font-size: 13px; font-weight: 700; color: var(--teal); }
    .goal-bar-bg { height: 7px; background: var(--warm-gray); border-radius: 99px; overflow: hidden; }
    .goal-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--teal-light), var(--teal));
      border-radius: 99px;
      transition: width 0.6s ease;
    }
    .goal-amounts { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-secondary); margin-top: 3px; }

    .month-summary { display: flex; gap: 8px; }
    .month-box { flex: 1; background: var(--warm-gray); border-radius: 12px; padding: 12px; text-align: center; }
    .month-box-label { font-size: 10px; color: var(--text-secondary); }
    .month-box-value { font-size: 16px; font-weight: 700; margin-top: 3px; }
    .month-box-value.income { color: var(--positive); }
    .month-box-value.expense { color: var(--negative); }
    .month-box-value.savings { color: var(--teal); }

    /* â”€â”€ ê¸°ë¡ â”€â”€ */
    .record-tabs {
      display: flex;
      background: var(--warm-gray);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 14px;
    }
    .record-tab {
      flex: 1; padding: 10px; border: none; border-radius: 10px;
      background: transparent; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; color: var(--text-secondary);
    }
    .record-tab.active { background: white; color: var(--teal); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

    .form-group { margin-bottom: 12px; }
    .form-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 5px; display: block; }
    .form-input {
      width: 100%; padding: 11px 13px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 15px; background: white; outline: none;
      transition: border-color 0.2s;
      -webkit-appearance: none;
    }
    .form-input:focus { border-color: var(--teal); }
    .form-select {
      width: 100%; padding: 11px 13px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 15px; background: white; outline: none;
      appearance: none; -webkit-appearance: none; cursor: pointer;
    }
    .btn-primary {
      width: 100%; padding: 14px;
      background: var(--teal); color: white;
      border: none; border-radius: 12px;
      font-size: 16px; font-weight: 700; cursor: pointer;
      transition: background 0.2s; -webkit-appearance: none;
    }
    .btn-primary:active { background: var(--teal-dark); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

    /* ê±°ë˜ ë‚´ì—­ */
    .tx-list { margin-top: 14px; }
    .tx-item {
      display: flex; align-items: center;
      padding: 11px 0; border-bottom: 1px solid var(--border);
    }
    .tx-item:last-child { border-bottom: none; }
    .tx-icon {
      width: 38px; height: 38px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 17px; margin-right: 10px; flex-shrink: 0;
    }
    .tx-icon.income-icon { background: #E8F8F0; }
    .tx-icon.expense-icon { background: #FDE8E8; }
    .tx-info { flex: 1; min-width: 0; }
    .tx-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tx-cat { font-size: 10px; color: var(--text-secondary); margin-top: 1px; }
    .tx-amount { font-size: 14px; font-weight: 700; white-space: nowrap; }
    .tx-amount.income { color: var(--positive); }
    .tx-amount.expense { color: var(--negative); }
    .tx-date { font-size: 10px; color: var(--text-secondary); margin-top: 2px; text-align: right; }
    .tx-who-badge {
      font-size: 10px; padding: 1px 6px; border-radius: 99px;
      background: var(--warm-gray); color: var(--text-secondary);
      margin-left: 4px; white-space: nowrap;
    }

    /* â”€â”€ ìì‚° â”€â”€ */
    .asset-section-title {
      font-size: 12px; font-weight: 700; color: var(--text-secondary);
      margin: 14px 0 6px;
    }
    .asset-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 13px 14px; background: white; border-radius: 12px;
      margin-bottom: 7px; border: 1px solid var(--border);
    }
    .asset-item-left { display: flex; align-items: center; gap: 10px; }
    .asset-emoji { font-size: 20px; }
    .asset-name { font-size: 14px; font-weight: 600; }
    .asset-value { font-size: 14px; font-weight: 700; }
    .asset-value.debt { color: var(--negative); }
    .asset-total-row {
      display: flex; justify-content: space-between;
      padding: 13px 14px; background: var(--warm-gray);
      border-radius: 12px; font-weight: 700; font-size: 14px; margin-top: 3px;
    }
    .btn-add {
      width: 100%; padding: 11px;
      background: transparent; color: var(--teal);
      border: 2px dashed var(--teal-light); border-radius: 12px;
      font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 4px;
      transition: all 0.2s;
    }
    .btn-add:active { background: rgba(42,157,143,0.06); }

    /* â”€â”€ ëª©í‘œ â”€â”€ */
    .goal-card {
      background: white; border-radius: 16px; padding: 18px;
      margin-bottom: 10px; border: 1px solid var(--border);
    }
    .goal-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .goal-card-title { font-size: 15px; font-weight: 700; display: flex; align-items: center; gap: 7px; }
    .goal-status { font-size: 11px; padding: 3px 10px; border-radius: 99px; font-weight: 600; }
    .goal-status.on-track { background: #E8F8F0; color: var(--positive); }
    .goal-status.behind   { background: #FDE8E8; color: var(--negative); }
    .goal-big-bar-bg { height: 10px; background: var(--warm-gray); border-radius: 99px; overflow: hidden; margin-bottom: 7px; }
    .goal-big-bar-fill { height: 100%; border-radius: 99px; transition: width 0.8s ease; }
    .goal-big-bar-fill.green { background: linear-gradient(90deg, #4CAF50, #27AE60); }
    .goal-big-bar-fill.teal  { background: linear-gradient(90deg, var(--teal-light), var(--teal)); }
    .goal-big-bar-fill.gold  { background: linear-gradient(90deg, #F7C948, var(--gold)); }
    .goal-detail-row { display: flex; justify-content: space-between; font-size: 13px; margin-top: 6px; }
    .goal-detail-row span:first-child { color: var(--text-secondary); }
    .goal-detail-row span:last-child { font-weight: 600; }

    .add-goal-form {
      background: white; border-radius: 16px; padding: 18px;
      border: 2px dashed var(--teal-light); margin-bottom: 10px; display: none;
    }
    .add-goal-form.open { display: block; }
    .emoji-picker { display: flex; gap: 7px; flex-wrap: wrap; margin-bottom: 6px; }
    .emoji-opt {
      width: 34px; height: 34px; border: 2px solid var(--border); border-radius: 8px;
      background: white; font-size: 17px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.15s;
    }
    .emoji-opt.selected { border-color: var(--teal); background: rgba(42,157,143,0.08); }

    /* â”€â”€ ì„¤ì • â”€â”€ */
    .setting-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 0; border-bottom: 1px solid var(--border);
    }
    .setting-item:last-child { border-bottom: none; }
    .setting-label { font-size: 15px; font-weight: 600; }
    .setting-desc { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    .couple-badge {
      display: flex; align-items: center; gap: 6px;
      background: var(--warm-gray); padding: 7px 12px;
      border-radius: 99px; font-size: 12px; font-weight: 600;
    }

    /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.45); z-index: 200;
      align-items: flex-end; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: white; border-radius: 24px 24px 0 0;
      padding: 20px 18px calc(24px + var(--safe-bottom));
      width: 100%; max-width: 480px;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 99px; margin: 0 auto 18px; }
    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 18px; }

    /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
    .toast {
      position: fixed;
      bottom: calc(24px + var(--safe-bottom));
      left: 50%; transform: translateX(-50%) translateY(80px);
      background: #2C3E50; color: white;
      padding: 11px 20px; border-radius: 99px;
      font-size: 13px; font-weight: 600; z-index: 300;
      transition: transform 0.3s ease; white-space: nowrap;
      max-width: calc(100vw - 32px); text-align: center;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* â”€â”€ ë¹ˆ ìƒíƒœ â”€â”€ */
    .empty-state { text-align: center; padding: 28px 16px; color: var(--text-secondary); }
    .empty-state .empty-icon { font-size: 36px; margin-bottom: 10px; }
    .empty-state p { font-size: 13px; line-height: 1.6; }

    /* â”€â”€ ë¡œë”© ìŠ¤í”¼ë„ˆ â”€â”€ */
    .spinner {
      display: inline-block; width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: white; border-radius: 50%;
      animation: spin 0.7s linear infinite; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<!-- â”€â”€ í—¤ë” â”€â”€ -->
<header class="app-header">
  <div class="app-header-inner">
    <div>
      <h1>ğŸ¡ ìš°ë¦¬ ì§‘ ìì‚°ê´€ë¦¬</h1>
      <div class="subtitle" id="headerDate"></div>
    </div>
    <div class="sync-dot" id="syncDot" title="Firebase ì—°ê²° ìƒíƒœ"></div>
  </div>
</header>

<!-- â”€â”€ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€ -->
<nav class="tab-nav">
  <button class="tab-btn active" onclick="switchTab('home')">
    <span class="tab-icon">ğŸ </span>í™ˆ
  </button>
  <button class="tab-btn" onclick="switchTab('record')">
    <span class="tab-icon">âœï¸</span>ê¸°ë¡
  </button>
  <button class="tab-btn" onclick="switchTab('asset')">
    <span class="tab-icon">ğŸ’°</span>ìì‚°
  </button>
  <button class="tab-btn" onclick="switchTab('goal')">
    <span class="tab-icon">ğŸ¯</span>ëª©í‘œ
  </button>
  <button class="tab-btn" onclick="switchTab('setting')">
    <span class="tab-icon">âš™ï¸</span>ì„¤ì •
  </button>
</nav>

<!-- â•â•â• í™ˆ â•â•â• -->
<section class="screen active" id="screen-home">
  <div class="net-worth-card">
    <div class="net-worth-label">ìˆœìì‚°</div>
    <div class="net-worth-value" id="homeNetWorth">â‚©0</div>
    <div class="net-worth-sub" id="homeNetWorthMsg">í•¨ê»˜ ì‹œì‘í•˜ëŠ” ìš°ë¦¬ì˜ ì²« ê±¸ìŒ ğŸ’š</div>
    <div class="net-worth-breakdown">
      <div class="breakdown-item">
        <div class="breakdown-label">ìì‚°</div>
        <div class="breakdown-value" id="homeAssetTotal">â‚©0</div>
      </div>
      <div class="breakdown-item">
        <div class="breakdown-label">ë¶€ì±„</div>
        <div class="breakdown-value" id="homeDebtTotal">â‚©0</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title" id="homeMonthLabel">ì´ë²ˆ ë‹¬ ìš”ì•½</div>
    <div class="month-summary">
      <div class="month-box">
        <div class="month-box-label">ìˆ˜ì…</div>
        <div class="month-box-value income" id="homeMonthIncome">â‚©0</div>
      </div>
      <div class="month-box">
        <div class="month-box-label">ì§€ì¶œ</div>
        <div class="month-box-value expense" id="homeMonthExpense">â‚©0</div>
      </div>
      <div class="month-box">
        <div class="month-box-label">ì €ì¶•</div>
        <div class="month-box-value savings" id="homeMonthSavings">â‚©0</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">ëª©í‘œ ì§„í–‰ë¥ </div>
    <div id="homeGoalList">
      <div class="empty-state"><div class="empty-icon">ğŸ¯</div><p>ëª©í‘œë¥¼ ì„¤ì •í•˜ë©´ ì—¬ê¸°ì— ë³´ì—¬ìš”</p></div>
    </div>
  </div>
</section>

<!-- â•â•â• ê¸°ë¡ â•â•â• -->
<section class="screen" id="screen-record">
  <div class="record-tabs">
    <button class="record-tab active" id="incomeTab" onclick="switchRecordTab('income')">+ ìˆ˜ì…</button>
    <button class="record-tab" id="expenseTab" onclick="switchRecordTab('expense')">- ì§€ì¶œ</button>
  </div>
  <div class="card">
    <div class="form-group">
      <label class="form-label">ê¸ˆì•¡ (ì›)</label>
      <input type="number" class="form-input" id="txAmount" placeholder="0" min="0" inputmode="numeric" />
    </div>
    <div class="form-group">
      <label class="form-label">ë‚´ì—­</label>
      <input type="text" class="form-input" id="txName" placeholder="ì˜ˆ) ì›”ê¸‰, ë§ˆíŠ¸ ì¥ë³´ê¸°" />
    </div>
    <div class="form-group">
      <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
      <select class="form-select" id="txCategory"><option value="">ì„ íƒí•˜ì„¸ìš”</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">ë‚ ì§œ</label>
      <input type="date" class="form-input" id="txDate" />
    </div>
    <div class="form-group">
      <label class="form-label">ëˆ„ê°€</label>
      <select class="form-select" id="txWho">
        <option value="ë‚¨í¸">ë‚¨í¸</option>
        <option value="ì™€ì´í”„">ì™€ì´í”„</option>
        <option value="ê³µë™">ê³µë™</option>
      </select>
    </div>
    <button class="btn-primary" id="txSubmitBtn" onclick="addTransaction()">ê¸°ë¡í•˜ê¸°</button>
  </div>

  <div class="card">
    <div class="card-title">ìµœê·¼ ë‚´ì—­</div>
    <div class="tx-list" id="txList">
      <div class="empty-state"><div class="empty-icon">âœï¸</div><p>ì²« ë²ˆì§¸ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”</p></div>
    </div>
  </div>
</section>

<!-- â•â•â• ìì‚° â•â•â• -->
<section class="screen" id="screen-asset">
  <div class="asset-section-title">ìì‚°</div>
  <div id="assetList"></div>
  <div class="asset-total-row"><span>ìì‚° í•©ê³„</span><span id="assetSum">â‚©0</span></div>
  <button class="btn-add" onclick="openAssetModal('asset')">+ ìì‚° ì¶”ê°€</button>

  <div class="asset-section-title">ë¶€ì±„</div>
  <div id="debtList"></div>
  <div class="asset-total-row"><span>ë¶€ì±„ í•©ê³„</span><span id="debtSum" style="color:var(--negative)">â‚©0</span></div>
  <button class="btn-add" onclick="openAssetModal('debt')">+ ë¶€ì±„ ì¶”ê°€</button>

  <div class="asset-section-title">íˆ¬ì</div>
  <div id="investList"></div>
  <div class="asset-total-row"><span>íˆ¬ì í•©ê³„</span><span id="investSum">â‚©0</span></div>
  <button class="btn-add" onclick="openAssetModal('invest')">+ íˆ¬ì ì¶”ê°€</button>
</section>

<!-- â•â•â• ëª©í‘œ â•â•â• -->
<section class="screen" id="screen-goal">
  <button class="btn-add" style="margin-bottom:10px" onclick="toggleGoalForm()">+ ìƒˆ ëª©í‘œ ì¶”ê°€</button>
  <div class="add-goal-form" id="addGoalForm">
    <div class="card-title">ìƒˆ ëª©í‘œ ë§Œë“¤ê¸°</div>
    <div class="form-group">
      <label class="form-label">ëª©í‘œ ì•„ì´ì½˜</label>
      <div class="emoji-picker">
        <button class="emoji-opt selected" data-emoji="ğŸ " onclick="selectEmoji(this)">ğŸ </button>
        <button class="emoji-opt" data-emoji="âœˆï¸" onclick="selectEmoji(this)">âœˆï¸</button>
        <button class="emoji-opt" data-emoji="ğŸš—" onclick="selectEmoji(this)">ğŸš—</button>
        <button class="emoji-opt" data-emoji="ğŸ›¡ï¸" onclick="selectEmoji(this)">ğŸ›¡ï¸</button>
        <button class="emoji-opt" data-emoji="ğŸ‘¶" onclick="selectEmoji(this)">ğŸ‘¶</button>
        <button class="emoji-opt" data-emoji="ğŸ“" onclick="selectEmoji(this)">ğŸ“</button>
        <button class="emoji-opt" data-emoji="ğŸ’" onclick="selectEmoji(this)">ğŸ’</button>
        <button class="emoji-opt" data-emoji="ğŸŒ¿" onclick="selectEmoji(this)">ğŸŒ¿</button>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ëª©í‘œ ì´ë¦„</label>
      <input type="text" class="form-input" id="goalName" placeholder="ì˜ˆ) ë¹„ìƒê¸ˆ ë§ˆë ¨, ìœ ëŸ½ ì—¬í–‰" />
    </div>
    <div class="form-group">
      <label class="form-label">ëª©í‘œ ê¸ˆì•¡ (ì›)</label>
      <input type="number" class="form-input" id="goalTarget" placeholder="5000000" min="0" inputmode="numeric" />
    </div>
    <div class="form-group">
      <label class="form-label">í˜„ì¬ ëª¨ì¸ ê¸ˆì•¡ (ì›)</label>
      <input type="number" class="form-input" id="goalCurrent" placeholder="0" min="0" inputmode="numeric" />
    </div>
    <div class="form-group">
      <label class="form-label">ëª©í‘œ ê¸°í•œ</label>
      <input type="month" class="form-input" id="goalDeadline" />
    </div>
    <button class="btn-primary" onclick="addGoal()">ëª©í‘œ ì €ì¥</button>
  </div>
  <div id="goalList">
    <div class="empty-state"><div class="empty-icon">ğŸ¯</div><p>ì²« ëª©í‘œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!<br>ì‘ì€ ëª©í‘œ í•˜ë‚˜ê°€ ì‹œì‘ì…ë‹ˆë‹¤.</p></div>
  </div>
</section>

<!-- â•â•â• ì„¤ì • â•â•â• -->
<section class="screen" id="screen-setting">
  <div class="card">
    <div class="card-title">í”„ë¡œí•„</div>
    <div class="setting-item">
      <div><div class="setting-label">ë‚¨í¸ ì´ë¦„</div></div>
      <input type="text" class="form-input" id="husbandName" placeholder="ì´ë¦„ ì…ë ¥"
        style="width:110px;padding:7px 11px;font-size:14px" onchange="saveSettings()" />
    </div>
    <div class="setting-item">
      <div><div class="setting-label">ì™€ì´í”„ ì´ë¦„</div></div>
      <input type="text" class="form-input" id="wifeName" placeholder="ì´ë¦„ ì…ë ¥"
        style="width:110px;padding:7px 11px;font-size:14px" onchange="saveSettings()" />
    </div>
  </div>

  <div class="card">
    <div class="card-title">Firebase ë™ê¸°í™”</div>
    <div class="setting-item">
      <div>
        <div class="setting-label">ğŸ‘« ì‹¤ì‹œê°„ ê³µìœ </div>
        <div class="setting-desc" id="syncStatusText">ì—°ê²° ì¤‘...</div>
      </div>
      <div class="couple-badge" id="syncBadge">â³ ì—°ê²° ì¤‘</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">ë°ì´í„°</div>
    <div class="setting-item">
      <div>
        <div class="setting-label">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</div>
        <div class="setting-desc">JSON íŒŒì¼ë¡œ ë°±ì—…</div>
      </div>
      <button class="btn-primary" style="width:auto;padding:7px 14px;font-size:13px" onclick="exportData()">ë‚´ë³´ë‚´ê¸°</button>
    </div>
    <div class="setting-item">
      <div>
        <div class="setting-label" style="color:var(--negative)">ë°ì´í„° ì´ˆê¸°í™”</div>
        <div class="setting-desc">Firebaseì˜ ëª¨ë“  ë°ì´í„° ì‚­ì œ</div>
      </div>
      <button style="padding:7px 14px;font-size:13px;background:var(--negative);color:white;border:none;border-radius:8px;cursor:pointer"
        onclick="resetData()">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="card" style="text-align:center;padding:14px">
    <p style="font-size:11px;color:var(--text-secondary)">ìš°ë¦¬ ì§‘ ìì‚°ê´€ë¦¬ v2.0 Â· Firebase ì‹¤ì‹œê°„ ë™ê¸°í™”<br>ğŸ”’ woori-jasangi.firebaseapp.com</p>
  </div>
</section>

<!-- â”€â”€ ìì‚° ì¶”ê°€ ëª¨ë‹¬ â”€â”€ -->
<div class="modal-overlay" id="assetModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="assetModalTitle">ìì‚° ì¶”ê°€</div>
    <input type="hidden" id="assetModalType" />
    <div class="form-group">
      <label class="form-label">ì´ë¦„</label>
      <input type="text" class="form-input" id="assetModalName" placeholder="ì˜ˆ) êµ­ë¯¼ì€í–‰ ì˜ˆê¸ˆ" />
    </div>
    <div class="form-group">
      <label class="form-label">ê¸ˆì•¡ (ì›)</label>
      <input type="number" class="form-input" id="assetModalValue" placeholder="0" min="0" inputmode="numeric" />
    </div>
    <div class="form-group">
      <label class="form-label">ì•„ì´ì½˜</label>
      <div class="emoji-picker" id="assetEmojiPicker">
        <button class="emoji-opt selected" data-emoji="ğŸ¦" onclick="selectAssetEmoji(this)">ğŸ¦</button>
        <button class="emoji-opt" data-emoji="ğŸ " onclick="selectAssetEmoji(this)">ğŸ </button>
        <button class="emoji-opt" data-emoji="ğŸš—" onclick="selectAssetEmoji(this)">ğŸš—</button>
        <button class="emoji-opt" data-emoji="ğŸ’µ" onclick="selectAssetEmoji(this)">ğŸ’µ</button>
        <button class="emoji-opt" data-emoji="ğŸ“ˆ" onclick="selectAssetEmoji(this)">ğŸ“ˆ</button>
        <button class="emoji-opt" data-emoji="ğŸª™" onclick="selectAssetEmoji(this)">ğŸª™</button>
        <button class="emoji-opt" data-emoji="ğŸ’³" onclick="selectAssetEmoji(this)">ğŸ’³</button>
        <button class="emoji-opt" data-emoji="ğŸ“¦" onclick="selectAssetEmoji(this)">ğŸ“¦</button>
      </div>
    </div>
    <button class="btn-primary" onclick="saveAsset()">ì €ì¥</button>
    <button style="width:100%;padding:11px;background:transparent;border:none;color:var(--text-secondary);font-size:14px;cursor:pointer;margin-top:6px" onclick="closeAssetModal()">ì·¨ì†Œ</button>
  </div>
</div>

<!-- â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ -->
<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getDatabase, ref, onValue, set, push, remove, update, serverTimestamp }
  from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyC7s5OCPUYmyFtW2h_PkW50QYu9X0wNq5E",
  authDomain: "woori-jasangi.firebaseapp.com",
  projectId: "woori-jasangi",
  storageBucket: "woori-jasangi.firebasestorage.app",
  messagingSenderId: "203066420682",
  appId: "1:203066420682:web:10bd64624cec2dc60d7333",
  databaseURL: "https://woori-jasangi-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¡œì»¬ ìƒíƒœ (Firebaseì—ì„œ ì±„ì›Œì§)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.DB = {
  transactions: {},
  assets: {},
  debts: {},
  investments: {},
  goals: {},
  settings: { husbandName: 'ë‚¨í¸', wifeName: 'ì™€ì´í”„' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.fmt = (n) => n === 0 ? 'â‚©0' : 'â‚©' + Math.abs(Math.round(n)).toLocaleString('ko-KR');
window.fmtSigned = (n) => (n >= 0 ? '+' : '-') + window.fmt(n);
window.today = () => new Date().toISOString().slice(0, 10);
window.thisMonth = () => new Date().toISOString().slice(0, 7);

window.showToast = (msg) => {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì—°ê²° ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setConnected(ok) {
  const dot = document.getElementById('syncDot');
  const badge = document.getElementById('syncBadge');
  const text = document.getElementById('syncStatusText');
  if (ok) {
    dot.className = 'sync-dot live';
    badge.textContent = 'ğŸ’š ì‹¤ì‹œê°„ ì—°ê²°ë¨';
    text.textContent = 'ë‚¨í¸Â·ì™€ì´í”„ ë°ì´í„° ì‹¤ì‹œê°„ ê³µìœ  ì¤‘';
  } else {
    dot.className = 'sync-dot offline';
    badge.textContent = 'ğŸ”´ ì˜¤í”„ë¼ì¸';
    text.textContent = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”';
  }
}

const connRef = ref(db, '.info/connected');
onValue(connRef, (snap) => setConnected(snap.val() === true));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listenPath(path, key) {
  onValue(ref(db, path), (snap) => {
    window.DB[key] = snap.val() || {};
    renderAll();
  });
}

listenPath('transactions', 'transactions');
listenPath('assets',       'assets');
listenPath('debts',        'debts');
listenPath('investments',  'investments');
listenPath('goals',        'goals');
listenPath('settings',     'settings');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íƒ­ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.switchTab = (tab) => {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('screen-' + tab).classList.add('active');
  const idx = ['home','record','asset','goal','setting'].indexOf(tab);
  document.querySelectorAll('.tab-btn')[idx].classList.add('active');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê¸°ë¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const incomeCategories  = ['ê¸‰ì—¬', 'ë¶€ì—…/í”„ë¦¬ëœì„œ', 'ì´ì/ë°°ë‹¹', 'ê¸°íƒ€ìˆ˜ì…'];
const expenseCategories = ['ì‹ë¹„', 'êµí†µ', 'ìƒí™œìš©í’ˆ', 'ì˜ë¥˜', 'ì˜ë£Œ/ê±´ê°•', 'ë¬¸í™”/ì—¬ê°€', 'êµìœ¡', 'ê³µê³¼ê¸ˆ', 'í†µì‹ ë¹„', 'ì™¸ì‹', 'ê²½ì¡°ì‚¬', 'ê¸°íƒ€'];
let currentRecordTab = 'income';

window.switchRecordTab = (type) => {
  currentRecordTab = type;
  document.getElementById('incomeTab').classList.toggle('active', type === 'income');
  document.getElementById('expenseTab').classList.toggle('active', type === 'expense');
  renderCategorySelect();
};

function renderCategorySelect() {
  const cats = currentRecordTab === 'income' ? incomeCategories : expenseCategories;
  document.getElementById('txCategory').innerHTML =
    '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>' +
    cats.map(c => `<option value="${c}">${c}</option>`).join('');
}

window.addTransaction = async () => {
  const amount   = parseFloat(document.getElementById('txAmount').value);
  const name     = document.getElementById('txName').value.trim();
  const category = document.getElementById('txCategory').value;
  const date     = document.getElementById('txDate').value || window.today();
  const who      = document.getElementById('txWho').value;

  if (!amount || amount <= 0) { window.showToast('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!name)     { window.showToast('ë‚´ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!category) { window.showToast('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }

  const btn = document.getElementById('txSubmitBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';

  try {
    await push(ref(db, 'transactions'), {
      type: currentRecordTab, amount, name, category, date, who,
      createdAt: Date.now()
    });
    document.getElementById('txAmount').value = '';
    document.getElementById('txName').value = '';
    window.showToast(currentRecordTab === 'income' ? 'ğŸ’š ìˆ˜ì…ì´ ê¸°ë¡ë˜ì—ˆì–´ìš”!' : 'âœï¸ ì§€ì¶œì´ ê¸°ë¡ë˜ì—ˆì–´ìš”!');
  } catch(e) {
    window.showToast('âš ï¸ ì €ì¥ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ê¸°ë¡í•˜ê¸°';
  }
};

window.deleteTransaction = async (id) => {
  if (!confirm('ì´ ë‚´ì—­ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  await remove(ref(db, `transactions/${id}`));
};

function renderTransactions() {
  const list = document.getElementById('txList');
  const items = Object.entries(window.DB.transactions || {})
    .map(([id, v]) => ({...v, id}))
    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
    .slice(0, 20);

  if (!items.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">âœï¸</div><p>ì²« ë²ˆì§¸ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”</p></div>';
    return;
  }
  list.innerHTML = items.map(tx => `
    <div class="tx-item">
      <div class="tx-icon ${tx.type}-icon">${tx.type === 'income' ? 'ğŸ’š' : 'ğŸ§¾'}</div>
      <div class="tx-info">
        <div class="tx-name">${escHtml(tx.name)}</div>
        <div class="tx-cat">${escHtml(tx.category)} <span class="tx-who-badge">${escHtml(tx.who)}</span></div>
      </div>
      <div>
        <div class="tx-amount ${tx.type}">${tx.type === 'income' ? '+' : '-'}${window.fmt(tx.amount)}</div>
        <div class="tx-date">${tx.date}</div>
      </div>
      <button onclick="deleteTransaction('${tx.id}')" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:15px;padding-left:8px;flex-shrink:0">âœ•</button>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìì‚°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let assetModalMode = 'asset';
let selectedAssetEmoji = 'ğŸ¦';

window.openAssetModal = (type) => {
  assetModalMode = type;
  selectedAssetEmoji = type === 'debt' ? 'ğŸ’³' : type === 'invest' ? 'ğŸ“ˆ' : 'ğŸ¦';
  document.getElementById('assetModalTitle').textContent = {asset:'ìì‚° ì¶”ê°€',debt:'ë¶€ì±„ ì¶”ê°€',invest:'íˆ¬ì ì¶”ê°€'}[type];
  document.getElementById('assetModalType').value = type;
  document.getElementById('assetModalName').value = '';
  document.getElementById('assetModalValue').value = '';
  document.getElementById('assetModal').classList.add('open');
  document.querySelectorAll('#assetEmojiPicker .emoji-opt').forEach(btn => {
    btn.classList.toggle('selected', btn.dataset.emoji === selectedAssetEmoji);
  });
};
window.closeAssetModal = () => document.getElementById('assetModal').classList.remove('open');
window.selectAssetEmoji = (btn) => {
  document.querySelectorAll('#assetEmojiPicker .emoji-opt').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedAssetEmoji = btn.dataset.emoji;
};

window.saveAsset = async () => {
  const name  = document.getElementById('assetModalName').value.trim();
  const value = parseFloat(document.getElementById('assetModalValue').value);
  const type  = document.getElementById('assetModalType').value;
  if (!name)             { window.showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!value || value<=0){ window.showToast('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const pathMap = {asset:'assets', debt:'debts', invest:'investments'};
  await push(ref(db, pathMap[type]), { name, value, emoji: selectedAssetEmoji, createdAt: Date.now() });
  window.closeAssetModal();
  window.showToast('ì €ì¥ë˜ì—ˆì–´ìš” âœ…');
};

window.deleteAssetItem = async (type, id) => {
  if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
  const pathMap = {asset:'assets', debt:'debts', invest:'investments'};
  await remove(ref(db, `${pathMap[type]}/${id}`));
};

function renderAssets() {
  const renderList = (data, containerId, type) => {
    const el = document.getElementById(containerId);
    const items = Object.entries(data || {}).map(([id,v]) => ({...v, id}));
    if (!items.length) {
      el.innerHTML = `<div style="padding:10px 0;color:var(--text-secondary);font-size:12px;text-align:center">ì•„ì§ ì—†ì–´ìš”</div>`;
      return 0;
    }
    el.innerHTML = items.map(item => `
      <div class="asset-item">
        <div class="asset-item-left">
          <span class="asset-emoji">${item.emoji}</span>
          <div class="asset-name">${escHtml(item.name)}</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="asset-value ${type==='debt'?'debt':''}">${type==='debt'?'-':''}${window.fmt(item.value)}</div>
          <button onclick="deleteAssetItem('${type}','${item.id}')" style="background:none;border:none;color:#ccc;cursor:pointer;font-size:15px">âœ•</button>
        </div>
      </div>
    `).join('');
    return items.reduce((s,x) => s + x.value, 0);
  };

  const assetSum  = renderList(window.DB.assets,      'assetList',  'asset');
  const debtSum   = renderList(window.DB.debts,       'debtList',   'debt');
  const investSum = renderList(window.DB.investments, 'investList', 'invest');
  document.getElementById('assetSum').textContent  = window.fmt(assetSum);
  document.getElementById('debtSum').textContent   = window.fmt(debtSum);
  document.getElementById('investSum').textContent = window.fmt(investSum);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ëª©í‘œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedGoalEmoji = 'ğŸ ';

window.toggleGoalForm = () => document.getElementById('addGoalForm').classList.toggle('open');
window.selectEmoji = (btn) => {
  document.querySelectorAll('#addGoalForm .emoji-opt').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedGoalEmoji = btn.dataset.emoji;
};

window.addGoal = async () => {
  const name     = document.getElementById('goalName').value.trim();
  const target   = parseFloat(document.getElementById('goalTarget').value);
  const current  = parseFloat(document.getElementById('goalCurrent').value) || 0;
  const deadline = document.getElementById('goalDeadline').value;
  if (!name)            { window.showToast('ëª©í‘œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!target || target<=0){ window.showToast('ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  await push(ref(db, 'goals'), { name, emoji: selectedGoalEmoji, target, current, deadline, createdAt: Date.now() });
  ['goalName','goalTarget','goalCurrent','goalDeadline'].forEach(id => document.getElementById(id).value='');
  document.getElementById('addGoalForm').classList.remove('open');
  window.showToast('ğŸ¯ ëª©í‘œê°€ ì¶”ê°€ë˜ì—ˆì–´ìš”!');
};

window.updateGoalCurrent = async (id) => {
  const goal = window.DB.goals[id];
  if (!goal) return;
  const newVal = prompt('í˜„ì¬ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì›)', goal.current);
  if (newVal === null) return;
  const v = parseFloat(newVal);
  if (isNaN(v) || v < 0) { window.showToast('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  await update(ref(db, `goals/${id}`), { current: v });
  window.showToast('ëª©í‘œ ê¸ˆì•¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆì–´ìš” âœ…');
};

window.deleteGoal = async (id) => {
  if (!confirm('ëª©í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  await remove(ref(db, `goals/${id}`));
};

function renderGoals() {
  const el = document.getElementById('goalList');
  const items = Object.entries(window.DB.goals || {}).map(([id,v]) => ({...v, id}))
    .sort((a,b) => (a.createdAt||0)-(b.createdAt||0));
  if (!items.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ¯</div><p>ì²« ëª©í‘œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!<br>ì‘ì€ ëª©í‘œ í•˜ë‚˜ê°€ ì‹œì‘ì…ë‹ˆë‹¤.</p></div>';
    return;
  }
  const colors = ['teal','green','gold','teal'];
  el.innerHTML = items.map((goal, i) => {
    const pct = Math.min(100, Math.round((goal.current / goal.target) * 100));
    const remaining = goal.target - goal.current;
    const deadlineText = goal.deadline ? (() => { const [y,m] = goal.deadline.split('-'); return `${y}ë…„ ${m}ì›”`; })() : '';
    return `
      <div class="goal-card">
        <div class="goal-card-header">
          <div class="goal-card-title"><span>${goal.emoji}</span>${escHtml(goal.name)}</div>
          <span class="goal-status ${pct>=50?'on-track':'behind'}">${pct}%</span>
        </div>
        <div class="goal-big-bar-bg">
          <div class="goal-big-bar-fill ${colors[i%colors.length]}" style="width:${pct}%"></div>
        </div>
        <div class="goal-detail-row"><span>í˜„ì¬</span><span>${window.fmt(goal.current)}</span></div>
        <div class="goal-detail-row"><span>ëª©í‘œ</span><span>${window.fmt(goal.target)}</span></div>
        <div class="goal-detail-row"><span>ë‚¨ì€ ê¸ˆì•¡</span><span style="color:var(--teal)">${window.fmt(remaining)}</span></div>
        ${deadlineText ? `<div class="goal-detail-row"><span>ê¸°í•œ</span><span>${deadlineText}</span></div>` : ''}
        <div style="display:flex;gap:8px;margin-top:12px">
          <button onclick="updateGoalCurrent('${goal.id}')" style="flex:1;padding:9px;background:var(--teal);color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer">ê¸ˆì•¡ ìˆ˜ì •</button>
          <button onclick="deleteGoal('${goal.id}')" style="padding:9px 13px;background:var(--warm-gray);border:none;border-radius:10px;font-size:13px;cursor:pointer;color:var(--negative)">ì‚­ì œ</button>
        </div>
      </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í™ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome() {
  const assetTotal = Object.values(window.DB.assets||{}).reduce((s,x)=>s+x.value,0)
    + Object.values(window.DB.investments||{}).reduce((s,x)=>s+x.value,0);
  const debtTotal = Object.values(window.DB.debts||{}).reduce((s,x)=>s+x.value,0);
  const netWorth  = assetTotal - debtTotal;
  document.getElementById('homeNetWorth').textContent  = window.fmt(netWorth);
  document.getElementById('homeAssetTotal').textContent= window.fmt(assetTotal);
  document.getElementById('homeDebtTotal').textContent = window.fmt(debtTotal);

  const now = window.thisMonth();
  const txs = Object.values(window.DB.transactions||{}).filter(t=>t.date&&t.date.startsWith(now));
  const income  = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const d = new Date();
  document.getElementById('homeMonthLabel').textContent    = `${d.getMonth()+1}ì›” ìš”ì•½`;
  document.getElementById('homeMonthIncome').textContent   = window.fmt(income);
  document.getElementById('homeMonthExpense').textContent  = window.fmt(expense);
  document.getElementById('homeMonthSavings').textContent  = window.fmtSigned(income - expense);

  const goals = Object.entries(window.DB.goals||{}).map(([id,v])=>({...v,id}))
    .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0)).slice(0,3);
  const goalEl = document.getElementById('homeGoalList');
  if (!goals.length) {
    goalEl.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ¯</div><p>ëª©í‘œ íƒ­ì—ì„œ ëª©í‘œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</p></div>';
    return;
  }
  goalEl.innerHTML = goals.map(goal => {
    const pct = Math.min(100, Math.round((goal.current/goal.target)*100));
    return `
      <div class="goal-item">
        <div class="goal-header">
          <div class="goal-name"><span class="goal-emoji">${goal.emoji}</span>${escHtml(goal.name)}</div>
          <div class="goal-pct">${pct}%</div>
        </div>
        <div class="goal-bar-bg"><div class="goal-bar-fill" style="width:${pct}%"></div></div>
        <div class="goal-amounts"><span>${window.fmt(goal.current)}</span><span>ëª©í‘œ ${window.fmt(goal.target)}</span></div>
      </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„¤ì •
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.saveSettings = async () => {
  const h = document.getElementById('husbandName').value || 'ë‚¨í¸';
  const w = document.getElementById('wifeName').value || 'ì™€ì´í”„';
  await set(ref(db, 'settings'), { husbandName: h, wifeName: w });
  window.showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆì–´ìš”');
};

function renderSettings() {
  const s = window.DB.settings || {};
  document.getElementById('husbandName').value = s.husbandName || '';
  document.getElementById('wifeName').value    = s.wifeName    || '';
  // txWho ì˜µì…˜ë„ ì´ë¦„ ë°˜ì˜
  const whoSel = document.getElementById('txWho');
  if (whoSel) {
    whoSel.options[0].text = s.husbandName || 'ë‚¨í¸';
    whoSel.options[1].text = s.wifeName    || 'ì™€ì´í”„';
  }
}

window.exportData = () => {
  const blob = new Blob([JSON.stringify(window.DB, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `ìš°ë¦¬ì§‘ìì‚°_${window.today()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  window.showToast('ğŸ“¦ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!');
};

window.resetData = async () => {
  if (!confirm('Firebaseì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”? ë¶€ë¶€ ëª¨ë‘ì˜ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) return;
  await Promise.all([
    set(ref(db,'transactions'), null),
    set(ref(db,'assets'), null),
    set(ref(db,'debts'), null),
    set(ref(db,'investments'), null),
    set(ref(db,'goals'), null),
  ]);
  window.showToast('ì´ˆê¸°í™” ì™„ë£Œ');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// XSS ë°©ì§€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì „ì²´ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.renderAll = () => {
  renderHome();
  renderTransactions();
  renderAssets();
  renderGoals();
  renderSettings();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  const d = new Date();
  document.getElementById('headerDate').textContent =
    `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
  document.getElementById('txDate').value = window.today();
  renderCategorySelect();
  document.getElementById('assetModal').addEventListener('click', function(e) {
    if (e.target === this) window.closeAssetModal();
  });
});
</script>
</body>
</html>
